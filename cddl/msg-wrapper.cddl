; =====================================================================
; --- SATP message ---
; =====================================================================

satp-message = {
  ; --- Stage 1 ---
  ? verifiedOriginatorEntityId:          wrapped-acdc-vlei-lei-id,
  ? verifiedBeneficiaryEntityId:         wrapped-acdc-vlei-lei-id,
  ? senderGatewayOwnerId:                wrapped-acdc-vlei-lei-id,
  ? receiverGatewayOwnerId:              wrapped-acdc-vlei-lei-id,

  ? senderGatewayId:                     wrapped-acdc-vlei-ecr,
  ? recipientGatewayId:                  wrapped-acdc-vlei-ecr,
  ? senderGatewayNetworkId:              wrapped-acdc-vlei-ecr,
  ? recipientGatewayNetworkId:           wrapped-acdc-vlei-ecr,

  ? originatorPubkey:                    wrapped-key,
  ? beneficiaryPubkey:                   wrapped-key,
  ? senderGatewaySignaturePublicKey:     wrapped-key,
  ? receiverGatewaySignaturePublicKey:   wrapped-key,
  ? senderGatewayDeviceIdentityPubkey:   wrapped-key,
  ? receiverGatewayDeviceIdentityPubkey: wrapped-key,

  ; --- Stage 2 ---
  ? assetControllerCredential:
      wrapped-acdc-vlei-lei-id /
      wrapped-acdc-vlei-oor /
      wrapped-acdc-vlei-ecr,
  ? lockEvidenceIssuerCredential:
      wrapped-acdc-vlei-lei-id /
      wrapped-acdc-vlei-oor /
      wrapped-acdc-vlei-ecr,
  ? lockEvidenceVerificationKey:         wrapped-key,

  ; --- Stage 3 ---
  ? commitAuthorizingCredential:
      wrapped-acdc-vlei-lei-id /
      wrapped-acdc-vlei-oor /
      wrapped-acdc-vlei-ecr,
  ? commitVerificationKey:               wrapped-key,
  ? postCommitSecureChannelKey:          wrapped-key
}

; =====================================================================
; --- Common building blocks ---
; =====================================================================

; Allowed serialization formats for all ACDC vLEI wrappers
acdc-serializations =
  "(json|cbor|mgpk|cesr)"

; Optional extra parameters (quoted or unquoted) after profile
acdc-param-tail =
  "(?:;[A-Za-z0-9.-]+=(?:\\\"[^\\\"]*\\\"|[^;]+))*$"

; Profile name fragments
acdc-prof-lei = "LegalEntityvLEICredential"
acdc-prof-oor =
  "LegalEntityOfficialOrganizationalRolevLEICredential"
acdc-prof-ecr =
  "LegalEntityEngagementContextRolevLEICredential"

; =====================================================================
; --- Profileâ€‘specific content types ---
; =====================================================================

acdc-vlei-lei-content =
  tstr .regexp
    "^application/acdc\\+" // acdc-serializations //
    ";profile=\\\"urn:vlei:" // acdc-prof-lei // "\\\"" //
    acdc-param-tail
  / uint

acdc-vlei-oor-content =
  tstr .regexp
    "^application/acdc\\+" // acdc-serializations //
    ";profile=\\\"urn:vlei:" // acdc-prof-oor // "\\\"" //
    acdc-param-tail
  / uint

acdc-vlei-ecr-content =
  tstr .regexp
    "^application/acdc\\+" // acdc-serializations //
    ";profile=\\\"urn:vlei:" // acdc-prof-ecr // "\\\"" //
    acdc-param-tail
  / uint

; =====================================================================
; --- Wrapped ACDC vLEI wrapper definitions ---
; =====================================================================

wrapped-acdc-vlei-lei-id = {
  &(content) 0: acdc-vlei-lei-content,
  &(payload) 1: bytes / tstr
}

wrapped-acdc-vlei-oor = {
  &(content) 0: acdc-vlei-oor-content,
  &(payload) 1: bytes / tstr
}

wrapped-acdc-vlei-ecr = {
  &(content) 0: acdc-vlei-ecr-content,
  &(payload) 1: bytes / tstr
}

; =====================================================================
; --- Wrapped key definitions ---
; =====================================================================

wrapped-key = one-of-cose-or-jwk

one-of-cose-or-jwk = [
  {
    &(content) 0:
      tstr .regexp "application/cose;cose-type=\\\"cose-key\\\"" /
      uint,
    &(payload) 1: bytes
  }
  /
  {
    &(content) 0:
      tstr .regexp "application/jwk\\+json" /
      uint,
    &(payload) 1: tstr
  }
]


